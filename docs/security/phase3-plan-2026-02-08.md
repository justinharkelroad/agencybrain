# Phase 3 Access Hardening Plan (2026-02-08)

## Objective
Complete the remaining tenant-boundary hardening after Phase 1 and Phase 2 by closing high-risk `SECURITY DEFINER` and edge-auth gaps still reachable from production app paths.

## Current Status (Before Phase 3)
- Phase 1 (staff call-scoring/auth): deployed and validated in production.
- Phase 2 (subscription/call-balance auth): deployed and validated in production.
- Edge auth standardization slice deployed for:
  - `purchase-call-pack`
  - `save-report`
  - `roleplay-config`

## Phase 3 Scope
1. Remaining high-traffic `SECURITY DEFINER` RPCs without explicit caller validation.
2. Remaining edge functions with mixed auth paths that can drift from policy.
3. Privilege/grant cleanup for tenant-sensitive RPC signatures.
4. Repeatable tamper tests that prove cross-agency deny and own-agency allow.

## High-Signal Findings From Audit

### A. `get_contacts_by_stage` (High Risk)
- File lineage ends at `supabase/migrations/20260123142055_fc5dc794-bc06-4141-b04a-c609e8cf4a12.sql`.
- Pattern: `SECURITY DEFINER` + `p_agency_id` + no `auth.uid()/has_agency_access` check.
- Risk: cross-agency contact data retrieval by parameter tampering.

### B. `get_dashboard_daily` (High Risk)
- File lineage ends at `supabase/migrations/20260203234028_filter_dashboard_daily_by_include_in_metrics.sql`.
- Pattern: `SECURITY DEFINER` + `p_agency_slug` + no caller validation.
- Risk: cross-agency metrics retrieval by slug tampering.

### C. Exchange lookup RPCs (Medium Risk)
- `search_exchange_users`, `get_conversation_participants` are `SECURITY DEFINER` with broad profile reads.
- Risk: over-broad user-directory enumeration unless constrained to caller context.
- Planned for Phase 3 Batch 2 after current production-critical tenant boundaries.

## Batch Plan

### Batch 1 (P0) - Tenant Data RPC Hardening (Execute Now)
Deliverables:
- `supabase/migrations/20260208170000_phase3_batch1_harden_contacts_and_dashboard_rpcs.sql`
- Client compatibility patch in `src/hooks/useContacts.ts`

Changes:
1. Harden `get_contacts_by_stage`:
- Add deny-by-default auth branch:
  - `auth.uid()` path -> `has_agency_access(auth.uid(), p_agency_id)`
  - `p_staff_session_token` path -> `verify_staff_session(token, p_agency_id)`
  - otherwise unauthorized
- Add explicit EXECUTE grants after `REVOKE PUBLIC`.

2. Harden `get_dashboard_daily`:
- Add deny-by-default auth branch:
  - `auth.uid()` path -> `has_agency_access(auth.uid(), agency_id_from_slug)`
  - `p_staff_session_token` path -> `verify_staff_session(token, agency_id_from_slug)`
  - otherwise unauthorized
- Add explicit EXECUTE grants after `REVOKE PUBLIC`.

3. Add optional staff-session token passthrough for contacts hook calls to avoid staff regression.

Validation:
- JWT own-agency: 200
- JWT cross-agency: 401/403
- staff session own-agency: 200
- staff session cross-agency: 401/403

### Batch 2 (P1) - Exchange RPC Constraining
Target:
- `search_exchange_users`
- `get_conversation_participants`

Changes:
- Remove caller-controlled identity parameters where possible.
- Bind read scope to `auth.uid()` and conversation membership constraints.
- Reapply least-privilege EXECUTE grants.

### Batch 3 (P1) - Edge Auth Standardization Completion
Target remaining tenant-facing functions using ad-hoc auth checks.

Changes:
- Move to `verifyRequest` standard where endpoint semantics require user/staff dual-mode.
- Keep strict JWT-only for admin endpoints.

### Batch 4 (P2) - Regression Automation + Release Gate
Deliverables:
- Reusable curl scripts for core RPC matrix.
- “Do not ship” checklist requiring deny/allow evidence.

## Risk and Break Surface
- Batch 1 app break risk: Low to moderate.
- Main risk vector: staff-session callers failing if token not forwarded.
- Mitigation applied: contacts hook now forwards `p_staff_session_token` when present.

## Definition of Done
1. Hardened RPCs enforce deny-by-default with production-verified matrix.
2. No high-traffic tenant RPC remains callable cross-agency by parameter tampering.
3. Remaining medium-risk directory/search surfaces are scheduled and tracked in Batch 2.
