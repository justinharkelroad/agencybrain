name: Staff Access Audit               

  on:
    # Run daily at 5am Eastern Time (10:00 UTC in winter, 09:00 UTC in
  summer)
    schedule:
      - cron: '0 10 * * *'  # 10:00 UTC = 5:00 AM ET (standard time)

    # Allow manual trigger
    workflow_dispatch:
      inputs:
        auto_fix:
          description: 'Auto-fix issues and create PR'
          required: false
          default: 'true'
          type: boolean
        notify_slack:
          description: 'Send Slack notification'
          required: false
          default: 'true'
          type: boolean

    # Also run on PRs that modify edge functions or migrations
    pull_request:
      paths:
        - 'supabase/functions/**'
        - 'supabase/migrations/**'

  env:
    NODE_VERSION: '20'

  jobs:
    audit:
      name: Audit Staff Access
      runs-on: ubuntu-latest
      outputs:
        issues_found: ${{ steps.audit.outputs.issues_found }}
        high_severity: ${{ steps.audit.outputs.high_severity }}
        auto_fixable: ${{ steps.audit.outputs.auto_fixable }}

      steps:
        - name: Checkout code
          uses: actions/checkout@v4
          with:
            fetch-depth: 0

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: ${{ env.NODE_VERSION }}
            cache: 'npm'

        - name: Install dependencies
          run: npm ci

        - name: Run audit
          id: audit
          run: |
            npx ts-node scripts/staff-access-audit.ts --json >
  audit-result.json

            ISSUES=$(jq '.issues | length' audit-result.json)
            HIGH=$(jq '[.issues[] | select(.severity == "high")] |
  length' audit-result.json)
            FIXABLE=$(jq '[.issues[] | select(.autoFixable == true)] |
  length' audit-result.json)

            echo "issues_found=$ISSUES" >> $GITHUB_OUTPUT
            echo "high_severity=$HIGH" >> $GITHUB_OUTPUT
            echo "auto_fixable=$FIXABLE" >> $GITHUB_OUTPUT

            npx ts-node scripts/staff-access-audit.ts > audit-report.md

            echo "### Staff Access Audit Results" >> $GITHUB_STEP_SUMMARY
            cat audit-report.md >> $GITHUB_STEP_SUMMARY

        - name: Upload audit results
          uses: actions/upload-artifact@v4
          with:
            name: audit-results
            path: |
              audit-result.json
              audit-report.md

        - name: Fail if high severity issues on PR
          if: github.event_name == 'pull_request' &&
  steps.audit.outputs.high_severity > 0
          run: |
            echo "::error::Found ${{ steps.audit.outputs.high_severity }}
   high severity staff access issues"
            exit 1

    notify:
      name: Send Notifications
      needs: [audit]
      runs-on: ubuntu-latest
      if: |
        always() &&
        (github.event_name == 'schedule' ||
         (github.event_name == 'workflow_dispatch' && inputs.notify_slack
   == 'true'))

      steps:
        - name: Send Slack notification
          if: env.SLACK_WEBHOOK_URL != ''
          env:
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          run: |
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"Staff Access Audit: Found ${{
  needs.audit.outputs.issues_found }} issues (${{
  needs.audit.outputs.high_severity }} high severity)"}' \
              "$SLACK_WEBHOOK_URL"
